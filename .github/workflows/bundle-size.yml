name: Bundle Size Analysis

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write

jobs:
  analyze-bundle-size:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5
        with:
          fetch-depth: 0

      - name: Install pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0

      - name: Use Node.js 24.x
        uses: actions/setup-node@a0853c24544627f65ddf259abe73b1d18a591444 # v5
        with:
          node-version: 24.x
          registry-url: https://registry.npmjs.org/
          cache: pnpm

      - name: Build base branch bundles
        run: |
          git checkout ${{ github.base_ref }}
          pnpm install
          pnpm build
          pnpm test:bundle-size
          pnpm test:vue-bundle-size
          cp bench/bundle/dist/client/client/minimal.mjs /tmp/base-client.mjs
          cp bench/bundle/dist/server/server/minimal.mjs /tmp/base-server.mjs
          cp bench/bundle/dist/vue-server/vue-server/minimal.mjs /tmp/base-vue-server.mjs
          cp bench/bundle/dist/vue-client/vue-client/minimal.mjs /tmp/base-vue-client.mjs
          git checkout -

      - name: Build PR bundles
        run: |
          pnpm install
          pnpm build
          pnpm test:bundle-size
          pnpm test:vue-bundle-size

      - uses: oven-sh/setup-bun@735343b667d3e6f658f44d0eca948eb6282f2b76 # v2

      - name: Run analyze script
        id: analyze
        run: |
          output=$(bun bench/bundle/analyze.ts /tmp/base-client.mjs /tmp/base-server.mjs /tmp/base-vue-client.mjs /tmp/base-vue-server.mjs)
          echo "$output"
          echo "result<<EOF" >> $GITHUB_OUTPUT
          echo "$output" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post comment on PR
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2
        with:
          header: Bundle Size Analysis
          message: |
            ### Bundle Size Analysis

            ${{ steps.analyze.outputs.result }}
